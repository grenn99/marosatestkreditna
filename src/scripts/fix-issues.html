<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Issues</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #8B4513;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
    }
    button {
      background-color: #8B4513;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover {
      background-color: #A0522D;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Fix Issues</h1>
  
  <div class="card">
    <h2>Fix Darilni Paket Image</h2>
    <p>This will fix the image URL for the "Darilni paket" product by:</p>
    <ul>
      <li>Setting the main image URL to <code>./images/darilni_paket/gift_package.jpg</code></li>
      <li>Adding <code>./images/paket 3.jpg</code> to the additional images</li>
      <li>Setting the category to "gift"</li>
    </ul>
    <button id="fixDarilniPaketButton">Fix Darilni Paket</button>
    <pre id="darilniPaketOutput">Results will appear here...</pre>
  </div>
  
  <div class="card">
    <h2>Fix Admin Access</h2>
    <p>This will fix admin access issues by:</p>
    <ul>
      <li>Clearing all admin-related cache for the current user</li>
      <li>Reloading the page to re-authenticate</li>
    </ul>
    <button id="fixAdminAccessButton">Fix Admin Access</button>
  </div>
  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    
    // Get Supabase credentials from URL parameters (for security, don't hardcode them)
    const urlParams = new URLSearchParams(window.location.search);
    const supabaseUrl = urlParams.get('url');
    const supabaseKey = urlParams.get('key');
    
    if (!supabaseUrl || !supabaseKey) {
      document.getElementById('darilniPaketOutput').textContent = 'Error: Missing Supabase URL or key. Add them as URL parameters: ?url=YOUR_URL&key=YOUR_KEY';
    }
    
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    // Fix Darilni Paket Image
    document.getElementById('fixDarilniPaketButton').addEventListener('click', async () => {
      const outputEl = document.getElementById('darilniPaketOutput');
      outputEl.textContent = 'Searching for "Darilni paket" product...\n';
      
      try {
        // Find the product
        const { data: products, error: findError } = await supabase
          .from('products')
          .select('*')
          .ilike('name', '%Darilni paket%');
        
        if (findError) {
          throw findError;
        }
        
        if (!products || products.length === 0) {
          outputEl.textContent += 'No "Darilni paket" product found.\n';
          return;
        }
        
        outputEl.textContent += `Found ${products.length} matching products.\n`;
        
        // Update each matching product
        for (const product of products) {
          outputEl.textContent += `Updating product ID ${product.id}...\n`;
          
          // Set the correct image path and category
          const updateData = {
            image_url: './images/darilni_paket/gift_package.jpg',
            category: 'gift',
            // Make sure additional_images includes the selected file
            additional_images: product.additional_images || []
          };
          
          // Add the additional image if it's not already there
          const additionalImagePath = './images/paket 3.jpg';
          if (!updateData.additional_images.includes(additionalImagePath)) {
            updateData.additional_images.push(additionalImagePath);
          }
          
          // Update the product
          const { error: updateError } = await supabase
            .from('products')
            .update(updateData)
            .eq('id', product.id);
          
          if (updateError) {
            outputEl.textContent += `Error updating product ${product.id}: ${updateError.message}\n`;
          } else {
            outputEl.textContent += `Successfully updated product ${product.id}.\n`;
          }
        }
        
        outputEl.textContent += 'Update process completed.\n';
      } catch (error) {
        outputEl.textContent += `Error: ${error.message}\n`;
      }
    });
    
    // Fix Admin Access
    document.getElementById('fixAdminAccessButton').addEventListener('click', () => {
      try {
        // Clear all admin-related cache keys
        const clearAdminCache = (userId) => {
          if (!userId) return;
          
          localStorage.removeItem(`admin_status_${userId}`);
          localStorage.removeItem(`admin_status_timestamp_${userId}`);
          localStorage.removeItem(`admin_edge_checked_${userId}`);
          localStorage.removeItem(`admin_edge_checked_timestamp_${userId}`);
          localStorage.removeItem(`admin_edge_result_${userId}`);
          localStorage.removeItem(`admin_db_checked_timestamp_${userId}`);
          localStorage.removeItem(`admin_db_result_${userId}`);
          
          console.log('Admin cache cleared for user:', userId);
        };
        
        // Get the current user from Supabase
        supabase.auth.getUser().then(({ data }) => {
          if (data?.user) {
            clearAdminCache(data.user.id);
            alert('Admin cache cleared. The page will now reload.');
            window.location.reload();
          } else {
            alert('No user found. Please log in first.');
          }
        });
      } catch (error) {
        alert(`Error fixing admin access: ${error.message}`);
      }
    });
  </script>
</body>
</html>
